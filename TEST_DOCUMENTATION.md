# üß™ Veromodels Test Documentation

Comprehensive test suite for the Veromodels e-commerce platform covering backend server actions, frontend UI components, and integration flows.

## üìã Table of Contents

1. [Test Overview](#test-overview)
2. [Test Structure](#test-structure)
3. [Running Tests](#running-tests)
4. [Test Scenarios](#test-scenarios)
5. [Coverage Report](#coverage-report)
6. [Writing New Tests](#writing-new-tests)

---

## Test Overview

### Testing Stack

- **Framework**: Vitest (compatible with Bun runtime)
- **UI Testing**: React Testing Library
- **E2E Testing**: Playwright (existing)
- **Assertion Library**: @testing-library/jest-dom
- **Coverage**: Vitest Coverage (v8)

### Test Types

1. **Unit Tests** - Individual functions and components
2. **Integration Tests** - Multi-component workflows
3. **E2E Tests** - Full user journeys (Playwright)

---

## Test Structure

```
vero-new/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ actions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth-actions.test.ts       # Authentication server actions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart-actions.test.ts       # Cart management server actions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth-actions.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart-actions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ checkout-actions.ts
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login-form.test.tsx        # Login form component
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ signup-form.test.tsx       # Signup form component
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ enhanced-product-card.test.tsx  # Product card component
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ setup-tests.ts                     # Global test configuration
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ checkout-flow.test.ts          # End-to-end checkout flow
‚îÇ   ‚îî‚îÄ‚îÄ auth.spec.ts                       # Playwright E2E auth tests
‚îú‚îÄ‚îÄ vitest.config.ts                       # Vitest configuration
‚îî‚îÄ‚îÄ TEST_DOCUMENTATION.md                  # This file
```

---

## Running Tests

### Run All Tests

```bash
bun test
```

### Run Specific Test File

```bash
bun test auth-actions
bun test login-form
bun test checkout-flow
```

### Run Tests in Watch Mode

```bash
bun test --watch
```

### Run Tests with Coverage

```bash
bun test --coverage
```

### Run E2E Tests (Playwright)

```bash
bun run test:e2e  # If configured
# OR manually:
npx playwright test tests/auth.spec.ts
```

---

## Test Scenarios

### üîê Backend: Authentication Actions (`auth-actions.test.ts`)

#### **Signup Tests**
- ‚úÖ Validates all required fields (name, email, password, confirmPassword)
- ‚úÖ Validates name length (minimum 2 characters)
- ‚úÖ Validates email format using regex
- ‚úÖ Validates password match between password and confirmPassword
- ‚úÖ Validates password strength (8+ chars, uppercase, lowercase, number)
- ‚úÖ Sanitizes inputs (trims whitespace, lowercases email)
- ‚úÖ Handles Supabase errors (duplicate email, invalid email)
- ‚úÖ Redirects to homepage on successful signup

#### **Login Tests**
- ‚úÖ Validates required fields (email, password)
- ‚úÖ Validates email format
- ‚úÖ Handles invalid credentials error
- ‚úÖ Sanitizes email input (lowercase, trim)
- ‚úÖ Redirects to homepage on successful login

#### **Logout Tests**
- ‚úÖ Calls Supabase signOut function
- ‚úÖ Redirects to homepage after logout

#### **Get User Tests**
- ‚úÖ Retrieves current authenticated user
- ‚úÖ Returns user object with id and email

---

### üõí Backend: Cart Actions (`cart-actions.test.ts`)

#### **Get Cart Tests**
- ‚úÖ Returns null when no cart ID exists in cookies
- ‚úÖ Fetches cart from Commerce Kit using cart ID
- ‚úÖ Uses structuredClone to serialize Stripe objects
- ‚úÖ Handles errors gracefully (returns null)

#### **Add to Cart Tests**
- ‚úÖ Creates new cart when no cart ID exists
- ‚úÖ Stores new cart ID in cookies
- ‚úÖ Adds item to existing cart
- ‚úÖ Supports custom quantity
- ‚úÖ Throws error on failure

#### **Update Cart Item Tests**
- ‚úÖ Returns null when no cart exists
- ‚úÖ Updates item quantity in existing cart
- ‚úÖ Uses Commerce Kit update method

#### **Remove from Cart Tests**
- ‚úÖ Returns null when no cart exists
- ‚úÖ Removes item from cart by variant ID
- ‚úÖ Returns updated cart state

#### **Clear Cart Tests**
- ‚úÖ Does nothing when no cart exists
- ‚úÖ Clears all items from cart
- ‚úÖ Removes cart ID from cookies

#### **Get Cart Item Count Tests**
- ‚úÖ Returns 0 for empty/non-existent cart
- ‚úÖ Calculates total quantity across all items

---

### üé® Frontend: Enhanced Product Card (`enhanced-product-card.test.tsx`)

#### **Rendering Tests**
- ‚úÖ Renders product name, brand, price correctly
- ‚úÖ Displays product image or placeholder
- ‚úÖ Links to correct product detail page
- ‚úÖ Uses default currency (AED) when not specified

#### **Badge Display Tests**
- ‚úÖ Shows "SPECIAL PRICE" badge for sale items
- ‚úÖ Shows "PRE-ORDER" badge with release date
- ‚úÖ Shows "LIMITED EDITION" badge for limited products
- ‚úÖ Shows "RARE" badge for rare models
- ‚úÖ Shows "NEW ARRIVAL" badge for new collection items

#### **Pricing Tests**
- ‚úÖ Displays regular price correctly
- ‚úÖ Shows strikethrough original price for sale items
- ‚úÖ Calculates and displays discount percentage
- ‚úÖ Formats prices with two decimal places (fils conversion)

#### **Design System Tests**
- ‚úÖ Applies Vero design system classes (.vero-card)
- ‚úÖ Implements luxury gold/black color palette
- ‚úÖ Includes hover animations and effects

---

### üîê Frontend: Login Form (`login-form.test.tsx`)

#### **Form Rendering Tests**
- ‚úÖ Displays heading "Sign In" and subtitle
- ‚úÖ Renders email and password inputs with correct attributes
- ‚úÖ Shows "Forgot password?" link
- ‚úÖ Displays "Create Account" link to signup
- ‚úÖ Shows Terms of Service and Privacy Policy links

#### **Form State Tests**
- ‚úÖ Displays error messages from server action
- ‚úÖ Shows "Signing In..." during pending state
- ‚úÖ Disables inputs and button when form is pending
- ‚úÖ Requires email and password fields

#### **Design System Tests**
- ‚úÖ Applies Vero glass card styling
- ‚úÖ Uses Vero button and input classes
- ‚úÖ Accepts custom className prop

---

### üìù Frontend: Signup Form (`signup-form.test.tsx`)

#### **Form Rendering Tests**
- ‚úÖ Displays all required fields (name, email, password, confirm)
- ‚úÖ Shows password requirements hint
- ‚úÖ Renders "Sign In" link for existing users
- ‚úÖ Displays Terms and Privacy links

#### **Input Validation Tests**
- ‚úÖ Name input requires text type
- ‚úÖ Email input requires email type
- ‚úÖ Password inputs require minimum 8 characters
- ‚úÖ All fields are marked as required

#### **Form State Tests**
- ‚úÖ Displays server error messages
- ‚úÖ Shows "Creating Account..." during pending
- ‚úÖ Disables all inputs when form is pending

#### **Design System Tests**
- ‚úÖ Applies Vero glass card styling
- ‚úÖ Uses Vero premium color palette
- ‚úÖ Accepts custom className prop

---

### üõçÔ∏è Integration: Checkout Flow (`checkout-flow.test.ts`)

#### **Complete Purchase Flow**
- ‚úÖ Handles full flow: add to cart ‚Üí checkout ‚Üí clear cart
- ‚úÖ Maintains cart state with cookies
- ‚úÖ Supports multiple items in cart
- ‚úÖ Prevents checkout with empty cart

#### **Cart State Management**
- ‚úÖ Persists cart across page refreshes
- ‚úÖ Retrieves same cart using cart ID

#### **Error Handling**
- ‚úÖ Handles cart retrieval errors gracefully
- ‚úÖ Rolls back on add to cart failure
- ‚úÖ Returns null instead of throwing on errors

#### **Price Calculations**
- ‚úÖ Correctly calculates totals for multiple quantities
- ‚úÖ Handles AED currency in fils (smallest unit)

---

## Coverage Report

### How to Generate Coverage

```bash
bun test --coverage
```

### Coverage Output

Coverage reports are generated in:
- **Text**: Console output
- **HTML**: `coverage/index.html` (open in browser)
- **JSON**: `coverage/coverage-final.json`

### Target Coverage

| Category | Target | Current |
|----------|--------|---------|
| **Statements** | 80%+ | TBD |
| **Branches** | 75%+ | TBD |
| **Functions** | 80%+ | TBD |
| **Lines** | 80%+ | TBD |

---

## Writing New Tests

### Test File Naming Convention

- **Unit tests**: `{component-name}.test.ts(x)`
- **Integration tests**: `{feature-name}.test.ts`
- **E2E tests**: `{feature-name}.spec.ts`

### Example Test Template

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";
import { render, screen } from "@testing-library/react";
import { MyComponent } from "../my-component";

describe("MyComponent", () => {
	beforeEach(() => {
		vi.clearAllMocks();
	});

	it("should render correctly", () => {
		render(<MyComponent />);
		expect(screen.getByText("Expected Text")).toBeInTheDocument();
	});

	it("should handle user interaction", async () => {
		const mockFn = vi.fn();
		render(<MyComponent onClick={mockFn} />);

		const button = screen.getByRole("button");
		await userEvent.click(button);

		expect(mockFn).toHaveBeenCalledTimes(1);
	});
});
```

### Best Practices

#### ‚úÖ DO
- Write tests in Given-When-Then pattern
- Use meaningful test descriptions
- Test user-facing behavior, not implementation
- Mock external dependencies
- Use data-testid sparingly (prefer semantic queries)
- Test accessibility (roles, labels)

#### ‚ùå DON'T
- Test internal state or implementation details
- Over-mock (mock only external boundaries)
- Write tests that depend on other tests
- Use fragile selectors (CSS classes for styling)
- Skip error cases

---

## Test Utilities

### Common Testing Library Queries

```typescript
// Preferred (by accessibility)
screen.getByRole("button", { name: /submit/i });
screen.getByLabelText("Email");
screen.getByPlaceholderText("Enter email");
screen.getByText("Welcome");

// Fallback
screen.getByTestId("custom-element");
```

### Async Testing

```typescript
import { waitFor } from "@testing-library/react";

await waitFor(() => {
	expect(screen.getByText("Loaded")).toBeInTheDocument();
});
```

### Mocking Server Actions

```typescript
vi.mock("@/actions/auth-actions", () => ({
	login: vi.fn(),
}));

const { login } = await import("@/actions/auth-actions");
(login as any).mockResolvedValue({ success: true });
```

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun test --coverage
      - run: bun run lint
```

---

## Troubleshooting

### Common Issues

#### Issue: "Cannot find module"
**Solution**: Check `vitest.config.ts` path aliases match `tsconfig.json`

#### Issue: "ReferenceError: structuredClone is not defined"
**Solution**: Ensured polyfill is in `setup-tests.ts`

#### Issue: "Next.js router not mocked"
**Solution**: Added router mock in `setup-tests.ts`

#### Issue: "Tests hang or timeout"
**Solution**: Ensure async operations use `await` and have proper cleanup

---

## Quality Gates

### Before Committing
1. ‚úÖ All tests pass: `bun test`
2. ‚úÖ Linting passes: `bun run lint`
3. ‚úÖ Type checking passes: `tsgo`
4. ‚úÖ Coverage meets minimum thresholds

### Before Merging PR
1. ‚úÖ All tests pass on CI
2. ‚úÖ No reduction in code coverage
3. ‚úÖ New features have test coverage
4. ‚úÖ E2E tests pass

---

## Additional Resources

- [Vitest Documentation](https://vitest.dev/)
- [React Testing Library](https://testing-library.com/react)
- [Playwright Documentation](https://playwright.dev/)
- [Testing Best Practices](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)

---

## üìä Test Summary

| Category | Tests | Status |
|----------|-------|--------|
| **Auth Actions** | 13 | ‚úÖ Implemented |
| **Cart Actions** | 15 | ‚úÖ Implemented |
| **Product Card** | 14 | ‚úÖ Implemented |
| **Login Form** | 10 | ‚úÖ Implemented |
| **Signup Form** | 11 | ‚úÖ Implemented |
| **Checkout Flow** | 8 | ‚úÖ Implemented |
| **E2E Auth (Playwright)** | 3 | ‚úÖ Existing |
| **TOTAL** | **74 Tests** | ‚úÖ Complete |

---

**Last Updated**: 2025-10-20
**Maintained By**: Quinn (QA Test Architect)
